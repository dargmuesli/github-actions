name: 'Release: Semantic'

on:
  workflow_call:
    inputs:
      CACHE_PATH:
        default: pnpm-lock.yaml
        required: false
        type: string
      NODE_VERSIONS:
        default: '[20]'
        required: false
        type: string
      PACKAGE_MANAGER:
        default: pnpm
        required: false
        type: string
    secrets:
      GH_TOKEN:
        required: true
      NPM_TOKEN:
        required: false

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    outputs:
      match: ${{ steps.validate.outputs.match }}
    steps:
      - name: Validate
        id: validate
        run: |
          if [[ ${{ github.ref }} =~ ^refs/heads/(master|next|next-major|beta|alpha)$ ]]; then
            echo "match=true" >> $GITHUB_OUTPUT
          fi
  semantic-release:
    name: Semantic Release
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.match == 'true'
    strategy:
      matrix:
        os: [ubuntu-latest]
        node: ${{ inputs.NODE_VERSIONS }}
    steps:
      - name: Checkout git repository
        uses: actions/checkout@8e5e7e5ab8b370d6c329ec480221332ada57f0ab # v3.5.2
        with:
          persist-credentials: false # to make `cycjimmy/semantic-release-action` work on protected branches
        #   token: ${{ secrets.GH_TOKEN }}

      - name: Setup package manager
        run: corepack enable

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          cache: ${{ inputs.PACKAGE_MANAGER }}
          cache-dependency-path: ${{ inputs.CACHE_PATH }}
          node-version: ${{ matrix.node }}

      - name: Cache node_modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ matrix.os }}-node-v${{ matrix.node }}-deps-${{ hashFiles(format('{0}{1}', github.workspace, '/pnpm-lock.yaml')) }} # TODO: make independent from package manager (https://github.com/dargmuesli/github-actions/issues/7)

      - name: Install dependencies
        if: steps.cache.outputs.cache-hit != 'true'
        run: pnpm install # TODO: make independent from package manager (https://github.com/dargmuesli/github-actions/issues/7)

      - name: Release
        uses: cycjimmy/semantic-release-action@8e58d20d0f6c8773181f43eb74d6a05e3099571d # v3.4.2
        with:
          extra_plugins: |
            @semantic-release/changelog
            @semantic-release/git
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }} # to allow for protected branches
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
